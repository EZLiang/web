---
layout: default
title: Books DB Health Check
---

<style>
    hr {
        border-top: 1px dotted grey;
    }

    button {
        margin: 0.1rem;
        width: 10rem;
    }

    div .imgBox {
        display: flex;
        margin: 0.1rem;
        border: 1px dotted gray;
    }
    div .toBottom {        
        align-self: flex-end;
    }
    div .imgBox img {
        width: 10rem;
    }
</style>


<button onclick="OnCheckUnUsedImages()">Check Un-used Images</button>
<button onclick="OnCheckBooks()">Check Books</button>
<hr>
<div id="resultList"></div>



<script type="text/javascript" src="manage.js"></script>
<script type="text/javascript">
    "use strict";

    function GetImageListOnDisk(handleImgList)
    {
        let request = new XMLHttpRequest();
        request.open('GET', '/admin/books/image/list');
        request.responseType = 'text';

        request.onload = function() {
            handleImgList(JSON.parse(request.response));
        }
        request.send();
    }

    function OnCheckUnUsedImages()
    {
        function UpdateResult(imgList) {
            let html = '<h3>Un-Used Images</h3>';

            if (imgList.length == 0) {
                html += '{none}';
            }
            else {
                html += '<div class="flex-container">';
                imgList.forEach( imgName =>  {
                    html += '<div class="imgBox"><div class="toBottom"><img src="../images/' + imgName + '"><br>' + 
                        imgName + ' &nbsp; <a onclick=OnDeleteImage("' + imgName + '")>&#x2718;</a></div></div>';
                });
                html += '</div>';
            }

            document.getElementById('resultList').innerHTML = html;
        }

        GetImageListOnDisk( imgList => {
            books.forEach( bookGroup => {
                bookGroup.list.forEach( book => {
                    let idx = imgList.indexOf(book.image);
                    if (idx >= 0) {
                        imgList.splice(idx, 1);
                    }

                    UpdateResult(imgList);
                });
            });
        });
    }

    function OnCheckBooks()
    {
        GetImageListOnDisk( imgList => {
        });
    }


    function CheckSpeicalChar()
    {
        function HasSpecialCharactar(string)
        {
            if (string === undefined) {
                return false;
            }

            var va = [...string];
            va.forEach( (c,idx) => {
                var charCode = c.charCodeAt(0);
                if (charCode < 10 || charCode > 126) {
                    return true;
                }
            });

            return false;
        }

        function SearchSpeicalCharInBookGroup(bookGroup, groupIndex)
        {
            var result = "";
            bookGroup.list.forEach( (book, bookIndex) => {
                if (HasSpecialCharactar(book.title) ||
                    HasSpecialCharactar(book.author) ||
                    HasSpecialCharactar(book.comment) ||
                    HasSpecialCharactar(book.description))
                {
                    result += '<hr>' + FormatBook(book, groupIndex, bookIndex);
                }
            });

            return result;
        }

        var resultHtml = "";

        books.forEach( (bookGroup, groupIndex) => {
            resultHtml += SearchSpeicalCharInBookGroup(bookGroup, groupIndex);
        })

        if (resultHtml == "") {
            resultHtml = "{none}";
        }

        document.getElementById("booksHasSpeicalChar").innerHTML = resultHtml;
    }


    function CheckImageStatus() {
        let request = new XMLHttpRequest();
        request.open('GET', '/admin/books/imageStatus');
        request.responseType = 'text';

        request.onload = function() {
            let result = JSON.parse(request.response);


            let html = '';
            result.ImagesNotUsed.forEach( imgName =>  {
                html += '<div class="imgBox"><div class="toBottom"><img src="../images/' + imgName + '"><br>' + 
                    imgName + ' &nbsp; <a onclick=OnDeleteImage("' + imgName + '")>&#x2718;</a></div></div>';
            });
            if (html == "") {
                html = "{none}";
            }
            else {
                html = '<div class="flex-container">' + html + '</div>';
            }
            document.getElementById('imagesNotUsed').innerHTML = html;


            html = '';
            result.BooksWithoutImage.forEach( item =>  {
                html += '<li>' + books[item.group].list[item.book].title + GetEditLink(item.group,item.book) + '</li>';
            });
            if (html == "") {
                html = "{none}";
            }
            else {
                html = '<ul>' + html + '</ul>'
            }
            document.getElementById('booksNoImage').innerHTML = html;


            html = '';
            result.BooksImageMissed.forEach( item => {
                html += '<li>' + books[item.group].list[item.book].title + GetEditLink(item.group,item.book) + '</li>';
            });
            if (html == "") {
                html = "{none}";
            }
            else {
                html = '<ul>' + html + '</ul>'
            }
            document.getElementById('booksMissingImage').innerHTML = html;
        };
        request.send();
    }

    function OnBookCheckHealth()
    {
        CheckSpeicalChar();
        CheckImageStatus();
    }

    function OnDeleteImage(imgName)
    {
        if (confirm('Are you sure you want to delete the selected image?') != true) {
            return;
        }

        let request = new XMLHttpRequest();
        request.open('DELETE', '/admin/books/image/' + imgName);
        request.responseType = 'text';

        request.onload = function() {
            alert(request.response);

            OnCheckUnUsedImages();
        }
        request.send();
    }

</script>
